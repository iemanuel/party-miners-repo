services:
  app_proxy:
    environment:
      APP_HOST: server
      APP_PORT: 3334
      PROXY_AUTH_WHITELIST: "/api/*"

  server:
    image: iemanuel18/party-pool:latest
    hostname: pool-party
    restart: on-failure
    stop_grace_period: 30s
    init: true
    expose:
      - "3333"
      - "3334"
    volumes:
      - "${APP_DATA_DIR}/data:/app/data"
    environment:
      - NODE_ENV=production
      - BITCOIN_RPC_URL=http://${APP_BITCOIN_NODE_IP}
      - BITCOIN_RPC_USER=${APP_BITCOIN_RPC_USER}
      - BITCOIN_RPC_PASSWORD=${APP_BITCOIN_RPC_PASS}
      - BITCOIN_RPC_PORT=${APP_BITCOIN_RPC_PORT}
      - BITCOIN_RPC_TIMEOUT=10000
      - API_PORT=3334
      - STRATUM_PORT=3333
      - NETWORK=${APP_NETWORK:-mainnet}
      - STRATUM_DEFAULT_DIFFICULTY=${APP_STRATUM_DIFFICULTY:-1024}
      - API_SECURE=false
      - ENABLE_SOLO=true
      - ENABLE_PROXY=false
      - POOL_IDENTIFIER="Pool Party on Umbrel"
      - DB_HOST=postgres
      - DB_PORT=5432
      - DB_USERNAME=postgres
      - DB_PASSWORD=${APP_POSTGRES_PASSWORD:-poolparty123}
      - DB_DATABASE=pool_party
      - PARTY_SOLO_ENABLED=${APP_PARTY_SOLO_ENABLED:-true}
      - CORE_WALLET_ADDRESS=${APP_CORE_WALLET_ADDRESS}
      - DONATION_WALLET_ADDRESS=${APP_DONATION_WALLET_ADDRESS:-bc1qxy2kgdygjrsqtzq2n0yrf2493p83kkfjhx0wlh}
      - SHARE_WINDOW_MINUTES=${APP_SHARE_WINDOW_MINUTES:-10}
      - REWARD_CONFIRMATIONS=${APP_REWARD_CONFIRMATIONS:-6}
    depends_on:
      postgres:
        condition: service_healthy

  stratum-proxy:
    image: alpine/socat:latest
    restart: unless-stopped
    ports:
      - "3333:3333"
    command: "tcp-listen:3333,fork,reuseaddr tcp-connect:server:3333"
    depends_on:
      - server

  postgres:
    image: postgres:15-alpine
    restart: unless-stopped
    environment:
      - POSTGRES_USER=postgres
      - POSTGRES_PASSWORD=${APP_POSTGRES_PASSWORD:-poolparty123}
      - POSTGRES_DB=pool_party
    volumes:
      - postgres-data:/var/lib/postgresql/data
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U postgres"]
      interval: 10s
      timeout: 5s
      retries: 5

volumes:
  postgres-data:

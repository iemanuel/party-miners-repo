version: "3.7"

services:
  app_proxy:
    environment:
      APP_HOST: server
      APP_PORT: ${APP_API_PORT:-3334}
      PROXY_AUTH_WHITELIST: "/api/*"
    depends_on:
      server:
        condition: service_started

  server:
    image: iemanuel18/party-pool:latest
    hostname: pool-party
    restart: on-failure
    stop_grace_period: 30s
    init: true
    expose:
      - "3334"
      - "3333"
    volumes:
      - "${APP_DATA_DIR}/data:/app/data"
    environment:
      # Server config
      - NODE_ENV=production
      # Bitcoin node connection (mapped from Umbrel variables)
      - BITCOIN_RPC_URL=http://${APP_BITCOIN_NODE_IP}
      - BITCOIN_RPC_USER=${APP_BITCOIN_RPC_USER}
      - BITCOIN_RPC_PASSWORD=${APP_BITCOIN_RPC_PASS}
      - BITCOIN_RPC_PORT=${APP_BITCOIN_RPC_PORT}
      - BITCOIN_RPC_TIMEOUT=10000
      # API and server ports
      - API_PORT=${APP_API_PORT:-3334}
      # Database configuration
      - APP_POSTGRES_HOST=postgres
      - APP_POSTGRES_PORT=5432
      - APP_POSTGRES_USER=postgres
      - APP_POSTGRES_PASSWORD=${APP_POSTGRES_PASSWORD:-dbpassword1234}
      - APP_POSTGRES_DB=pool_party
    depends_on:
      postgres:
        condition: service_healthy

  stratum-proxy:
    # Expose stratum port externally
    image: alpine/socat:latest
    restart: unless-stopped
    ports:
      - "3333:3333"
    command: "tcp-listen:3333,fork,reuseaddr tcp-connect:server:3333"
    depends_on:
      - server

  postgres:
    # Database
    image: postgres:15-alpine
    restart: unless-stopped
    environment:
      - POSTGRES_USER=postgres
      - POSTGRES_PASSWORD=${APP_POSTGRES_PASSWORD:-dbpassword1234}
      - POSTGRES_DB=pool_party
    volumes:
      - postgres-data:/var/lib/postgresql/data
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U postgres"]
      interval: 10s
      timeout: 5s
      retries: 5

volumes:
  postgres-data:
